
<html>
  <head>
    <style>
      .map {
        height: 80vh;
        width: 90vw;
        margin: 0 auto;
      }
    </style>
    <script>
    let coords = [];

    <% Address.all.each do |row| %>
      coords.push(<%= [row.id, row.lat.to_f, row.lng.to_f] %>)
      // <% puts [row.lat, row.lng] %>
    <% end %>

    // Initialize and add the map
  function initMap() {
  
    const map = new google.maps.Map(document.querySelector(".map"), {
      zoom: 5,
      center:  { lat: 39.8, lng: -98.5 },
    });


    

    setMarkers(map);
    
    //list of coordinates for addresses 
    //need to seed in addresses data---
    // let coords = []
    // for each address in address table (use address model) <---(use embedded ruby) <% %>  use active record to loop through
    // create a new sub array using addresss ID, lat, lng
    // add subarray to coords (push append ect)

    let contentString = 
      '<div id="content">' +
      '<div id="siteNotice">' +
      "</div>" +
      '<h1 id="firstHeading" class="firstHeading">Uluru</h1>' +
      '<div id="bodyContent">' +
      "<p><b>Uluru</b>, also referred to as <b>Ayers Rock</b>, is a large " +
      "sandstone rock formation in the southern part of the " +
      "Northern Territory, central Australia. It lies 335&#160;km (208&#160;mi) " +
      "south west of the nearest large town, Alice Springs; 450&#160;km " +
      "(280&#160;mi) by road. Kata Tjuta and Uluru are the two major " +
      "features of the Uluru - Kata Tjuta National Park. Uluru is " +
      "sacred to the Pitjantjatjara and Yankunytjatjara, the " +
      "Aboriginal people of the area. It has many springs, waterholes, " +
      "rock caves and ancient paintings. Uluru is listed as a World " +
      "Heritage Site.</p>" +
      '<p>Attribution: Uluru, <a href="https://en.wikipedia.org/w/index.php?title=Uluru&oldid=297882194">' +
      "https://en.wikipedia.org/w/index.php?title=Uluru</a> " +
      "(last visited June 22, 2009).</p>" +
      "</div>" +
      "</div>";

    const infowindow = new google.maps.InfoWindow({
      content: contentString,
    });
    // let marker;


    
    
    function setMarkers(map) {
      console.log(coords)
      for (let i = 0; i < coords.length; i++) {
        // This code add the markers to the map using lat and long coords
        const coordinates = coords[i];

        let marker = new google.maps.Marker({
          position: { lat: coordinates[1], lng: coordinates[2] },
          map,
        });

        // This code creates the info window content
        <% building = Building.find_by(:address_id => coordinates[0])%>
        let contact_name = <%= building.customer.contact_name%>

        // This code add the info window content to each marker
        let content = `
          <p>This is Address ${i}</p>
          <p>Customer Contact: ${contact_name}</p>
        `;

        const info = new google.maps.InfoWindow({
          content: content,
        });

        marker.addListener("click", () => {
          info.open({
            anchor: marker,
            map,
            shouldFocus: false,
          });
        });
      }
    }
  }
  
    

  </script>
  </head>
  <body>
    <h3>Our Customers</h3>
    <!--The div element for the map -->
    <div class="map"></div>
    

    <!-- Async script executes immediately and must be after any DOM elements used in callback. -->
    <script src="https://maps.googleapis.com/maps/api/js?key=<%= ENV["Maps_API_Key"] %>&callback=initMap&v=weekly" async></script>
  </body>
</html>
 